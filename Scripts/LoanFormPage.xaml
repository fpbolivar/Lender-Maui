<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:Lender.Views"
             xmlns:converters="clr-namespace:Lender.Converters"
             x:Class="Lender.LoanFormPage"
             Title="Loan Form"
             BackgroundColor="#0A1929"
             Padding="0"
             SafeAreaEdges="None">
    <ContentPage.Resources>
        <ResourceDictionary>
            <ResourceDictionary Source="Resources/Styles/Colors.xaml" />
            <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid RowDefinitions="*,Auto" BackgroundColor="#0A1929">
        <!-- Main Content -->
        <ScrollView Grid.Row="0" Padding="16">
            <VerticalStackLayout Spacing="16">
                <!-- Header back like calculator subpages -->
                <HorizontalStackLayout Spacing="10" Padding="0,10,0,0">
                    <Button Text="&lt;"
                            Command="{Binding BackCommand}"
                            BackgroundColor="Transparent"
                            TextColor="#FF9F43"
                            FontSize="28"
                            WidthRequest="44"
                            HeightRequest="44"
                            CornerRadius="22"
                            Padding="0" />
                    <Label Text="Loan Form"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="White"
                           VerticalTextAlignment="Center" />
                </HorizontalStackLayout>

                <!-- Top: Mode toggle styled like pills -->
                <HorizontalStackLayout Spacing="10" Padding="0,12,0,0">
                    <Button Text="Request"
                            Command="{Binding SetRequestModeCommand}"
                            TextColor="White"
                            CornerRadius="12" Padding="14,8"
                            FontSize="13"
                            BackgroundColor="{Binding IsRequestSelected, Converter={StaticResource BoolToColorConverter}}" />
                    <Button Text="Send"
                            Command="{Binding SetSendModeCommand}"
                            TextColor="White"
                            CornerRadius="12" Padding="14,8"
                            FontSize="13"
                            BackgroundColor="{Binding IsSendSelected, Converter={StaticResource BoolToColorConverter}}" />
                </HorizontalStackLayout>

                <!-- Simple form: amount + payback date -->
                <VerticalStackLayout Spacing="12">
                    <VerticalStackLayout.IsVisible>
                        <Binding Path="IsSimpleFormVisible" />
                    </VerticalStackLayout.IsVisible>

                    <HorizontalStackLayout Spacing="4">
                        <Label Text="Loan Amount" TextColor="White" />
                        <Label Text="*" TextColor="#FF6B6B" FontAttributes="Bold" />
                    </HorizontalStackLayout>
                    <Frame Padding="10,6" BackgroundColor="#132F4C" CornerRadius="10" HasShadow="False">
                        <Entry Text="{Binding AmountText}" Keyboard="Numeric" Placeholder="Enter amount (required)" TextColor="White" BackgroundColor="Transparent" />
                    </Frame>

                    <Label Text="Payback" TextColor="White" Padding="0,8,0,0" />
                    <HorizontalStackLayout Spacing="8">
                        <Button Text="By Date" 
                                Command="{Binding SetByDateCommand}"
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsByDateSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="By Time" 
                                Command="{Binding SetByTimeCommand}"
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsByTimeSelected, Converter={StaticResource BoolToColorConverter}}" />
                    </HorizontalStackLayout>

                    <Label Text="Payback Date" TextColor="White" IsVisible="{Binding ShowDatePicker}" />
                    <Frame Padding="0" BackgroundColor="White" CornerRadius="10" HasShadow="False" IsVisible="{Binding ShowDatePicker}">
                        <DatePicker Date="{Binding PaybackDate}" 
                                    MinimumDate="{Binding MinimumPaybackDate}"
                                    MaximumDate="{Binding MaximumPaybackDate}"
                                    TextColor="#0A1929" />
                    </Frame>

                    <!-- Time-based payback -->
                    <VerticalStackLayout Spacing="12" IsVisible="{Binding ShowTimeInput}">
                        <Frame Padding="10,6" BackgroundColor="#132F4C" CornerRadius="10" HasShadow="False">
                            <Entry Text="{Binding TimeDuration}" Keyboard="Numeric" Placeholder="Enter number" TextColor="White" BackgroundColor="Transparent" />
                        </Frame>
                        <HorizontalStackLayout Spacing="8">
                            <Button Text="Days" 
                                    Command="{Binding SetDaysCommand}"
                                    TextColor="White" 
                                    CornerRadius="12" Padding="14,8"
                                    FontSize="13"
                                    BackgroundColor="{Binding IsDaysSelected, Converter={StaticResource BoolToColorConverter}}" />
                            <Button Text="Months" 
                                    Command="{Binding SetMonthsCommand}"
                                    TextColor="White" 
                                    CornerRadius="12" Padding="14,8"
                                    FontSize="13"
                                    BackgroundColor="{Binding IsMonthsSelected, Converter={StaticResource BoolToColorConverter}}" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                <!-- Interest type selection -->
                <VerticalStackLayout Spacing="12">
                    <Label Text="Type of Interest" TextColor="White" />
                    <HorizontalStackLayout Spacing="8">
                        <Button Text="No Interest" 
                                Command="{Binding SetInterestTypeCommand}" 
                                CommandParameter="None" 
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsNoInterestSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="Simple Interest" 
                                Command="{Binding SetInterestTypeCommand}" 
                                CommandParameter="Simple" 
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsSimpleInterestSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="Compound Interest" 
                                Command="{Binding SetInterestTypeCommand}" 
                                CommandParameter="Compound" 
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsCompoundInterestSelected, Converter={StaticResource BoolToColorConverter}}" />
                    </HorizontalStackLayout>

                    <!-- Selecting an interest type toggles visibility of interest details automatically -->
                </VerticalStackLayout>

                <!-- Interest details (conditional) -->
                <VerticalStackLayout Spacing="12">
                    <VerticalStackLayout.IsVisible>
                        <Binding Path="IsInterestDetailsVisible" />
                    </VerticalStackLayout.IsVisible>

                    <Label Text="Interest Rate (%)" TextColor="White" />
                    <Frame Padding="10,6" BackgroundColor="#132F4C" CornerRadius="10" HasShadow="False">
                        <Entry Text="{Binding InterestRate}" Keyboard="Numeric" Placeholder="e.g. 5" TextColor="White" BackgroundColor="Transparent" />
                    </Frame>

                    <!-- Interest calculation method -->
                    <Label Text="Interest Calculation Method" TextColor="White" Margin="0,8,0,0" />
                    <HorizontalStackLayout Spacing="8">
                        <Button Text="Total %" 
                                Command="{Binding SetInterestMethodTotalCommand}" 
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsInterestMethodTotalSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="APR (Annual)" 
                                Command="{Binding SetInterestMethodAPRCommand}" 
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsInterestMethodAPRSelected, Converter={StaticResource BoolToColorConverter}}" />
                    </HorizontalStackLayout>

                    <!-- No Next button; payment frequency is visible as part of the simple page flow -->
                </VerticalStackLayout>

                <!-- Payment frequency -->
                <VerticalStackLayout Spacing="12" Padding="0,0,0,10">
                    <VerticalStackLayout.IsVisible>
                        <Binding Path="IsPaymentFrequencyVisible" />
                    </VerticalStackLayout.IsVisible>

                    <Label Text="Payment Frequency" TextColor="White" />
                    <HorizontalStackLayout Spacing="8">
                        <Button Text="One Time" 
                                Command="{Binding SelectPaymentFrequencyCommand}" 
                                CommandParameter="{Binding PaymentFrequencies[0]}"
                                TextColor="White" 
                                CornerRadius="12" Padding="10,8"
                                FontSize="11"
                                BackgroundColor="{Binding IsOneTimeSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="Two Payments" 
                                Command="{Binding SelectPaymentFrequencyCommand}" 
                                CommandParameter="{Binding PaymentFrequencies[1]}"
                                TextColor="White" 
                                CornerRadius="12" Padding="10,8"
                                FontSize="11"
                                BackgroundColor="{Binding IsTwoPaymentsSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="Daily" 
                                Command="{Binding SelectPaymentFrequencyCommand}" 
                                CommandParameter="{Binding PaymentFrequencies[2]}"
                                TextColor="White" 
                                CornerRadius="12" Padding="10,8"
                                FontSize="11"
                                BackgroundColor="{Binding IsDailySelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="Weekly" 
                                Command="{Binding SelectPaymentFrequencyCommand}" 
                                CommandParameter="{Binding PaymentFrequencies[3]}"
                                TextColor="White" 
                                CornerRadius="12" Padding="10,8"
                                FontSize="11"
                                BackgroundColor="{Binding IsWeeklySelected, Converter={StaticResource BoolToColorConverter}}" />
                    </HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="8">
                        <Button Text="Bi-week" 
                                Command="{Binding SelectPaymentFrequencyCommand}" 
                                CommandParameter="{Binding PaymentFrequencies[4]}"
                                TextColor="White" 
                                CornerRadius="12" Padding="10,8"
                                FontSize="11"
                                BackgroundColor="{Binding IsBiweekSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="Half Month" 
                                Command="{Binding SelectPaymentFrequencyCommand}" 
                                CommandParameter="{Binding PaymentFrequencies[5]}"
                                TextColor="White" 
                                CornerRadius="12" Padding="10,8"
                                FontSize="11"
                                BackgroundColor="{Binding IsHalfMonthSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="Monthly" 
                                Command="{Binding SelectPaymentFrequencyCommand}" 
                                CommandParameter="{Binding PaymentFrequencies[6]}"
                                TextColor="White" 
                                CornerRadius="12" Padding="10,8"
                                FontSize="11"
                                BackgroundColor="{Binding IsMonthlySelected, Converter={StaticResource BoolToColorConverter}}" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!-- Add Collateral -->
                <VerticalStackLayout Spacing="12" IsVisible="{Binding IsCollateralVisible}">
                    <Label Text="Add Collateral" TextColor="White" />
                    <HorizontalStackLayout Spacing="8">
                        <Button Text="Yes" 
                                Command="{Binding SetYesCollateralCommand}"
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsYesCollateralSelected, Converter={StaticResource BoolToColorConverter}}" />
                        <Button Text="No" 
                                Command="{Binding SetNoCollateralCommand}"
                                TextColor="White" 
                                CornerRadius="12" Padding="14,8"
                                FontSize="13"
                                BackgroundColor="{Binding IsNoCollateralSelected, Converter={StaticResource BoolToColorConverter}}" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!-- Next Button -->
                <Button Text="Next" 
                        Command="{Binding NextCommand}"
                        IsVisible="{Binding ShowNextButton}"
                        IsEnabled="{Binding IsLoanAmountValid}"
                        BackgroundColor="#FF9F43"
                        TextColor="#0A1929"
                        FontAttributes="Bold"
                        CornerRadius="12" 
                        Padding="16,12"
                        Margin="0,16,0,0"
                        Opacity="{Binding IsLoanAmountValid, Converter={StaticResource BoolToOpacityConverter}}" />
            </VerticalStackLayout>
        </ScrollView>

        <!-- Bottom Navigation -->
        <views:BottomNavView Grid.Row="1" SelectedTab="Loans" />
    </Grid>
</ContentPage>
